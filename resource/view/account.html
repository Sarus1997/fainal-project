<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ลงทะเบียนผู้ใช้งาน</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300&display=swap" rel="stylesheet">
    <link href="../../assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../assets/css/sidebars.css" rel="stylesheet">
    <link href="../../assets/css/header.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300&display=swap" rel="stylesheet">
    <link href="../../assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../assets/css/sidebars.css" rel="stylesheet">
    <link href="../../assets/css/header.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <link href="../../assets/css/chart_admin.css" rel="stylesheet">

    <!-- Favicons -->
    <link href="../../assets/img/favicon.png" rel="icon">
    <link href="../../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Raleway:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <!-- Vendor CSS Files -->
    <link href="../../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="../../assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="../../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="../../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="../../assets/css/main.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="../../assets/css/modal_generate.css" rel="stylesheet">

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/locales/de_DE.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/germanyLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/fonts/notosans-sc.js"></script>
</head>


<body>
    <!-- ======= navbar ======= -->
    <script src="../../components/navbar-1.js"></script>
    <navbar_1-components></navbar_1-components>

    <!-- ======= hero ======= -->
    <script src="../../components/hero-1.js"></script>
    <hero_1-components></hero_1-components>

    <main id="main">
        <div class="container col-lg-8" style="box-shadow: 0px 5px 5px rgb(131, 131, 131); border: 1px solid rgb(192, 192, 192);">

            <button type="button" class="btn btn-success m-2" onclick="Restaurants();">
                <img src="https://cdn-icons-png.flaticon.com/512/4689/4689666.png"
                    width="40px">&nbsp;&nbsp;&nbsp;ร้านค้า
            </button>
            <button type="button" class="btn btn-success m-2" onclick="Managers();">
                <img src="https://cdn-icons-png.flaticon.com/512/4205/4205906.png"
                    width="40px">&nbsp;&nbsp;&nbsp;ผู้บริหาร
            </button>

            <div id="Restaurants" class="col-12">
                <div class="container">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <img src="https://cdn-icons-png.flaticon.com/512/4689/4689666.png" width="100px">
                        </div>
                        <div class="col-12">
                            <table class="table table-striped table-sm align-middle text-left">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ร้านค้า</th>
                                        <th>ชื่อผู้ใช้</th>
                                        <!--                            <th>สถานะ</th>-->
                                        <th>แก้ไขข้อมูลร้านค้า</th>
                                        <th>ยกเลิกลงทะเบียน</th>
                                    </tr>
                                </thead>
                                <tbody id="tableRestaurants">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="Managers" class="col-12">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <img src="https://cdn-icons-png.flaticon.com/512/4205/4205906.png" width="100px">
                        </div>
                        
                        <div class="col-12">
                            <table class="table table-striped table-sm align-middle text-left">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ชื่อ</th>
                                        <th>ชื่อผู้ใช้</th>
                                        <!-- <th>สถานะ</th>-->
                                        <th>แก้ไขข้อมูลผู้บริหาร</th>
                                        <th>ยกเลิกลงทะเบียน</th>
                                    </tr>
                                </thead>
                                <tbody id="tableManagers">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <br>

    <!-- ======= Footer ======= -->
    <script src="../../components/footer.js"></script>
    <footer-components></footer-components>
    <!-- ======= End Footer ======= -->

    <a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>

    <div id="preloader"></div>



    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="../../assets/js/Chart_data.js"></script>
    <script src="../../assets/js/scripts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
    <script src="../../assets/demo/chart-area-demo.js"></script>
    <script src="../../assets/demo/chart-bar-demo.js"></script>
    <script src="../../assets/demo/chart-pie-demo.js"></script>
    <script src="../../assets/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Vendor JS Files -->
    <script src="../../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/vendor/aos/aos.js"></script>
    <script src="../../assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="../../assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="../../assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="../../assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="../../assets/vendor/php-email-form/validate.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Template Main JS File -->
    <script src="../../assets/js/main.js"></script>

</body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../../assets/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("role") == "admin") {
            console.log("admin")
        } else if (localStorage.getItem("role") == "restaurant") {
            window.location.href = "./charts.html";
        } else if (localStorage.getItem("role") == "manager") {
            window.location.href = "./center.html";
        } else {
            localStorage.clear();
            window.location.href = "../../../../fainal-project/login.html";
        }
        document.getElementById("Restaurants").style.display = "block";
        document.getElementById("Managers").style.display = "none";
        setProfile();
        Restaurants();
        loadRestaurants();
        loadManagers();
    }

    function setProfile() {
        username = localStorage.getItem("username");
        name = localStorage.getItem("name").toUpperCase();
        document.getElementById("profileImg").src = `https://ui-avatars.com/api/?name=${username}&background=random&rounded=true&size=50`;
        document.getElementById("profileName").innerHTML = `${name}&nbsp;`;
    }

    function Restaurants() {
        document.getElementById("Restaurants").style.display = "block";
        document.getElementById("Managers").style.display = "none";
    }

    function Managers() {
        document.getElementById("Restaurants").style.display = "none";
        document.getElementById("Managers").style.display = "block";
    }

    function logout() {
        localStorage.clear();
        window.location.reload();
    }

    function loadRestaurants() {
        $.ajax({
            url: "http://127.0.0.1:3000/admin/membership/restaurants",
            type: "GET",
            dataType: "json",
            success: function (data) {
                var html = "";
                for (var i = 0; i < data.length; i++) {
                    if (data[i].r_role == "restaurant") {
                        html += "<tr>";
                        html += "<td>" + `${i + 1}` + "</td>";
                        html += "<td>" + data[i].r_name + "</td>";
                        html += "<td>" + data[i].r_username + "</td>";
                        html += `<td><button type='button' class='btn btn-info' onclick='editRestaurant("${data[i]._id}", "${data[i].r_username}")'><i class='fa-solid fa-edit'></i></button></td>`;
                        html += `<td><button type='button' class='btn btn-warning' onclick='cancelRestaurant("${data[i]._id}", "${data[i].r_name}")'><i class='fa-solid fa-user-xmark'></i></button></td>`;
                        html += "</tr>";
                    }
                }
                document.getElementById("tableRestaurants").innerHTML = html;
            }
        });
    }

    function togglePassword() {
        $('#togglePassword').click(function () {
            var passwordInput = $('#password');
            var passwordToggle = $(this);
            if (passwordInput.attr('type') == 'password') {
                passwordInput.attr('type', 'text');
                passwordToggle.html('<i class="fa-solid fa-eye-slash"></i>');
            } else {
                passwordInput.attr('type', 'password');
                passwordToggle.html('<i class="fa-solid fa-eye"></i>');
            }
        });
    }

    function toggleConfirmPassword() {
        $('#toggleConfirmPassword').click(function () {
            var confirmPasswordInput = $('#confirmPassword');
            var confirmPasswordToggle = $(this);
            if (confirmPasswordInput.attr('type') == 'password') {
                confirmPasswordInput.attr('type', 'text');
                confirmPasswordToggle.html('<i class="fa-solid fa-eye-slash"></i>');
            } else {
                confirmPasswordInput.attr('type', 'password');
                confirmPasswordToggle.html('<i class="fa-solid fa-eye"></i>');
            }
        });
    }

    function editRestaurant(id, username) {
        Swal.fire({
            title: 'แก้ไขข้อมูลร้านค้า',
            html: '<div class="mb-3">' +
                '<label for="username" class="form-label">ชื่อผู้ใช้</label>' +
                '<input type="text" class="form-control" id="username" placeholder="ชื่อผู้ใช้" value="' + username + '">' +
                '</div>' +
                '<div class="mb-3">' +
                '<label for="password" class="form-label">รหัสผ่าน</label>' +
                '<div class="input-group">' +
                '<input type="password" class="form-control" id="password" placeholder="รหัสผ่าน">' +
                '<button class="btn btn-outline-secondary" type="button" id="togglePassword" onclick="togglePassword();">' +
                '<i class="fa-solid fa-eye"></i>' +
                '</button>' +
                '</div>' +
                '</div>' +
                '<div class="mb-3">' +
                '<label for="confirmPassword" class="form-label">ยืนยันรหัสผ่าน</label>' +
                '<div class="input-group">' +
                '<input type="password" class="form-control" id="confirmPassword" placeholder="ยืนยันรหัสผ่าน">' +
                '<button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword" onclick="toggleConfirmPassword();">' +
                '<i class="fa-solid fa-eye"></i>' +
                '</button>' +
                '</div>' +
                '</div>' +
                '</div>',
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                const username = Swal.getPopup().querySelector('#username').value
                const password = Swal.getPopup().querySelector('#password').value
                const confirmPassword = Swal.getPopup().querySelector('#confirmPassword').value
                if (!username || !password || !confirmPassword) {
                    Swal.showValidationMessage(`กรุณากรอกข้อมูลให้ครบ`)
                } else if (password != confirmPassword) {
                    Swal.showValidationMessage(`รหัสผ่านไม่ตรงกัน`)
                } else {
                    return { username: username, password: password }
                }
            },
            allowOutsideClick:
                () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "http://127.0.0.1:3000/admin/membership/restaurants/",
                    type: "PUT",
                    data: {
                        _id: id,
                        r_username: result.value.username,
                        r_password: result.value.password
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.status == "success") {
                            Swal.fire({
                                icon: 'success',
                                title: 'บันทึกข้อมูลสำเร็จ',
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                window.location.reload();
                            })
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'บันทึกข้อมูลไม่สำเร็จ',
                                showConfirmButton: false,
                                timer: 1500
                            })
                        }
                    }
                });
            }
        })
    }

    function cancelRestaurant(id, name) {
        Swal.fire({
            title: 'ยกเลิกร้านค้า',
            text: "คุณต้องการยกเลิกร้านค้า " + name + " ใช่หรือไม่?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ยืนยัน',
            cancelButtonText: 'ยกเลิก',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return { id: id }
            },
            allowOutsideClick:
                () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "http://127.0.0.1:3000/admin/membership/restaurants/",
                    type: "DELETE",
                    data: {
                        _id: result.value.id,
                        r_name: name
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.status == "success") {
                            Swal.fire({
                                icon: 'success',
                                title: 'ยกเลิกสำเร็จ',
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                window.location.reload();
                            })
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'ยกเลิกไม่สำเร็จ',
                                showConfirmButton: false,
                                timer: 1500
                            })
                        }
                    }
                });
            }
        })
    }

    function loadManagers() {
        $.ajax({
            url: "http://127.0.0.1:3000/admin/membership/managers",
            type: "GET",
            dataType: "json",
            success: function (data) {
                var html = "";
                for (var i = 0; i < data.length; i++) {
                    if (data[i].r_role == "manager") {
                        html += "<tr>";
                        html += "<td>" + `${i + 1}` + "</td>";
                        html += "<td>" + data[i].r_name + "</td>";
                        html += "<td>" + data[i].r_username + "</td>";

                        html += `<td><button type='button' class='btn btn-info' onclick='editManager("${data[i]._id}", "${data[i].r_name}", "${data[i].r_username}")'><i class='fa-solid fa-edit'></button></td>`;
                        html += `<td><button type='button' class='btn btn-warning' onclick='cancelManager("${data[i]._id}", "${data[i].r_name}")'><i class='fa-solid fa-user-xmark'></button></td>`;
                        html += "</tr>";
                    }
                }
                document.getElementById("tableManagers").innerHTML = html;
            }
        });
    }

    function editManager(id, name, username) {
        Swal.fire({
            title: 'แก้ไขข้อมูลผู้บริหาร',
            html: '<div class="mb-3">' +
                '<label for="name" class="form-label">ชื่อ-นามสกุล</label>' +
                '<input type="text" class="form-control" id="name" placeholder="ชื่อ-นามสกุล" value="' + name + '">' +
                '</div>' +
                '<div class="mb-3">' +
                '<label for="username" class="form-label">ชื่อผู้ใช้</label>' +
                '<input type="text" class="form-control" id="username" placeholder="ชื่อผู้ใช้" value="' + username + '">' +
                '</div>' +
                '<div class="mb-3">' +
                '<label for="password" class="form-label">รหัสผ่าน</label>' +
                '<div class="input-group">' +
                '<input type="password" class="form-control" id="password" placeholder="รหัสผ่าน">' +
                '<button class="btn btn-outline-secondary" type="button" id="togglePassword" onclick="togglePassword()">' +
                '<i class="fa-solid fa-eye"></i>' +
                '</button>' +
                '</div>' +
                '</div>' +
                '<div class="mb-3">' +
                '<label for="confirmPassword" class="form-label">ยืนยันรหัสผ่าน</label>' +
                '<div class="input-group">' +
                '<input type="password" class="form-control" id="confirmPassword" placeholder="ยืนยันรหัสผ่าน">' +
                '<button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword" onclick="toggleConfirmPassword()">' +
                '<i class="fa-solid fa-eye"></i>' +
                '</button>' +
                '</div>' +
                '</div>' +
                '</div>',
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                const name = Swal.getPopup().querySelector('#name').value
                const username = Swal.getPopup().querySelector('#username').value
                const password = Swal.getPopup().querySelector('#password').value
                const confirmPassword = Swal.getPopup().querySelector('#confirmPassword').value
                if (!name || !username || !password || !confirmPassword) {
                    Swal.showValidationMessage(`กรุณากรอกข้อมูลให้ครบ`)
                } else if (password != confirmPassword) {
                    Swal.showValidationMessage(`รหัสผ่านไม่ตรงกัน`)
                } else {
                    return { id: id, name: name, username: username, password: password }
                }
            },
            allowOutsideClick:
                () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "http://127.0.0.1:3000/admin/membership/managers",
                    type: "PUT",
                    data: {
                        _id: result.value.id,
                        r_name: result.value.name,
                        r_username: result.value.username,
                        r_password: result.value.password
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.status == "success") {
                            Swal.fire({
                                icon: 'success',
                                title: 'แก้ไขสำเร็จ',
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                window.location.reload();
                            })
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'แก้ไขไม่สำเร็จ',
                                showConfirmButton: false,
                                timer: 1500
                            })
                        }
                    }
                });
            }
        })
    }

    function cancelManager(id, name) {
        Swal.fire({
            title: 'ยกเลิกผู้บริหาร',
            text: "คุณต้องการยกเลิกผู้บริหาร " + name + " ใช่หรือไม่?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ยืนยัน',
            cancelButtonText: 'ยกเลิก',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return { id: id }
            },
            allowOutsideClick:
                () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "http://127.0.0.1:3000/admin/membership/managers",
                    type: "DELETE",
                    data: {
                        _id: result.value.id
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.status == "success") {
                            Swal.fire({
                                icon: 'success',
                                title: 'ยกเลิกสำเร็จ',
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                window.location.reload();
                            })
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'ยกเลิกไม่สำเร็จ',
                                showConfirmButton: false,
                                timer: 1500
                            })
                        }
                    }
                });
            }
        })
    }
</script>


</html>